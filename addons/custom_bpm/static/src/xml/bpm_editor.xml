<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="custom_bpm.BpmEditorWidget">
        <div class="bpm_editor_widget">
            <!-- Barre d'outils supérieure -->
            <div class="bpm_toolbar_top">
                <div class="bpm_toolbar_section">
                    <button class="btn btn-sm btn-outline-secondary" 
                            t-on-click="() => this.state.zoom = Math.max(0.25, this.state.zoom - 0.1)">
                        <i class="fa fa-search-minus"/>
                    </button>
                    <span class="bpm_zoom_indicator">
                        <t t-esc="Math.round(state.zoom * 100)"/>%
                    </span>
                    <button class="btn btn-sm btn-outline-secondary" 
                            t-on-click="() => this.state.zoom = Math.min(4, this.state.zoom + 0.1)">
                        <i class="fa fa-search-plus"/>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" 
                            t-on-click="() => { this.state.panOffset = { x: 0, y: 0 }; this.state.zoom = 1; }">
                        <i class="fa fa-home"/> Réinitialiser
                    </button>
                </div>
                
                <div class="bpm_toolbar_section ms-auto">
                    <button class="btn btn-sm btn-outline-danger" 
                            t-att-disabled="state.selectedCells.length === 0"
                            t-on-click="() => this.onDeleteSelected()">
                        <i class="fa fa-trash"/> Supprimer
                    </button>
                </div>
            </div>

            <!-- Conteneur principal -->
            <div class="bpm_main_container">
                <!-- Palette latérale - masquable -->
                <div class="bpm_palette" t-att-class="{'collapsed': state.paletteCollapsed}">
                    <div class="bpm_palette_header">
                        <i class="fa fa-shapes me-2"/>
                        <strong>Formes BPMN</strong>
                    </div>
                    <div class="bpm_palette_items">
                        <div class="bpm_palette_item" 
                             t-on-click="() => this.onPaletteItemClick('start')"
                             title="Début">
                            <div class="bpm_palette_shape bpm_shape_start"/>
                            <span>Début</span>
                        </div>
                        <div class="bpm_palette_item" 
                             t-on-click="() => this.onPaletteItemClick('task')"
                             title="Tâche">
                            <div class="bpm_palette_shape bpm_shape_task"/>
                            <span>Tâche</span>
                        </div>
                        <div class="bpm_palette_item" 
                             t-on-click="() => this.onPaletteItemClick('gateway')"
                             title="Décision">
                            <div class="bpm_palette_shape bpm_shape_gateway"/>
                            <span>Décision</span>
                        </div>
                        <div class="bpm_palette_item" 
                             t-on-click="() => this.onPaletteItemClick('end')"
                             title="Fin">
                            <div class="bpm_palette_shape bpm_shape_end"/>
                            <span>Fin</span>
                        </div>
                    </div>
                </div>
                
                <!-- Bouton pour masquer/afficher la palette -->
                <div class="bpm_palette_toggle" t-on-click="() => this.togglePalette()">
                    <i class="fa" t-att-class="state.paletteCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'"/>
                </div>

                <!-- Zone de dessin - prend tout l'espace -->
                <div class="bpm_canvas_container">
                    <svg t-ref="canvas" 
                         class="bpm_canvas"
                         t-att-class="{'connecting': state.isConnecting, 'panning': state.isPanning}"
                         width="100%" 
                         height="100%">
                        <!-- Définitions -->
                        <defs>
                            <marker id="arrowhead" 
                                    markerWidth="10" 
                                    markerHeight="10" 
                                    refX="9" 
                                    refY="3" 
                                    orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#333"/>
                            </marker>
                            <pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse">
                                <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                            </pattern>
                        </defs>

                        <!-- Groupe avec transformation (pan et zoom) -->
                        <g t-att-transform="`translate(${state.panOffset.x}, ${state.panOffset.y}) scale(${state.zoom})`">
                            <!-- Grille -->
                            <rect width="10000" height="10000" fill="url(#grid)" t-if="state.showGrid"/>

                            <!-- Connexions (edges) -->
                            <g class="bpm_edges">
                                <t t-foreach="state.cells" t-as="cell" t-key="cell.id">
                                    <t t-if="cell.type === 'edge'">
                                        <path t-att-d="getEdgePath(cell)"
                                              class="bpm_edge"
                                              t-att-class="{'bpm_edge_selected': isSelected(cell)}"
                                              stroke="#333333"
                                              stroke-width="2"
                                              fill="none"
                                              marker-end="url(#arrowhead)"
                                              t-on-click="() => this.onEdgeClick(cell)"/>
                                        
                                        <!-- Label de la connexion -->
                                        <t t-if="cell.label">
                                            <t t-set="source" t-value="getCellById(cell.source)"/>
                                            <t t-set="target" t-value="getCellById(cell.target)"/>
                                            <t t-if="source and target">
                                                <t t-set="labelX" t-value="(source.x + target.x + source.width + target.width) / 2"/>
                                                <t t-set="labelY" t-value="(source.y + target.y + source.height + target.height) / 2"/>
                                                <rect t-att-x="labelX - 30" 
                                                      t-att-y="labelY - 10" 
                                                      width="60" 
                                                      height="20" 
                                                      rx="4"
                                                      fill="white" 
                                                      stroke="#333" 
                                                      stroke-width="1"/>
                                                <text t-att-x="labelX" 
                                                      t-att-y="labelY" 
                                                      text-anchor="middle" 
                                                      alignment-baseline="middle"
                                                      font-size="11"
                                                      fill="#333">
                                                    <t t-esc="cell.label"/>
                                                </text>
                                            </t>
                                        </t>
                                    </t>
                                </t>
                                
                                <!-- Connexion temporaire -->
                                <t t-if="state.isConnecting and state.tempConnection">
                                    <path t-att-d="`M${state.connectionSourcePoint.x},${state.connectionSourcePoint.y} L${state.tempConnection.x},${state.tempConnection.y}`"
                                          class="bpm_edge_temp"
                                          stroke="#ffc107"
                                          stroke-width="2"
                                          stroke-dasharray="5,5"
                                          fill="none"
                                          marker-end="url(#arrowhead)"/>
                                </t>
                            </g>

                            <!-- Cellules (vertices) -->
                            <g class="bpm_vertices">
                                <t t-foreach="state.cells" t-as="cell" t-key="cell.id">
                                    <t t-if="cell.type === 'vertex'">
                                        <g t-att-class="{'bpm_vertex_selected': isSelected(cell), 'bpm_vertex_hovered': isHovered(cell)}"
                                           t-att-transform="`translate(${cell.x}, ${cell.y})`">
                                            
                                            <!-- Forme selon le type -->
                                            <t t-if="cell.shape === 'start'">
                                                <circle class="bpm_vertex"
                                                        cx="25" cy="25" r="25"
                                                        fill="#28a745"
                                                        stroke="#1e7e34"
                                                        stroke-width="2"/>
                                                <text x="25" y="25" 
                                                      text-anchor="middle" 
                                                      alignment-baseline="middle"
                                                      class="bpm_vertex_label"
                                                      fill="white" 
                                                      font-size="11" 
                                                      font-weight="bold">
                                                    <t t-esc="cell.label"/>
                                                </text>
                                            </t>
                                            
                                            <t t-elif="cell.shape === 'end'">
                                                <circle class="bpm_vertex"
                                                        cx="25" cy="25" r="25"
                                                        fill="#dc3545"
                                                        stroke="#c82333"
                                                        stroke-width="2"/>
                                                <circle cx="25" cy="25" r="15"
                                                        fill="#dc3545"
                                                        stroke="#c82333"
                                                        stroke-width="2"/>
                                                <text x="25" y="25" 
                                                      text-anchor="middle" 
                                                      alignment-baseline="middle"
                                                      class="bpm_vertex_label"
                                                      fill="white" 
                                                      font-size="11" 
                                                      font-weight="bold">
                                                    <t t-esc="cell.label"/>
                                                </text>
                                            </t>
                                            
                                            <t t-elif="cell.shape === 'gateway'">
                                                <polygon class="bpm_vertex"
                                                         points="30,0 60,30 30,60 0,30"
                                                         fill="#ffc107"
                                                         stroke="#e0a800"
                                                         stroke-width="2"/>
                                                <text x="30" y="30" 
                                                      text-anchor="middle" 
                                                      alignment-baseline="middle"
                                                      class="bpm_vertex_label"
                                                      fill="#000" 
                                                      font-size="10" 
                                                      font-weight="bold">
                                                    <t t-esc="cell.label"/>
                                                </text>
                                            </t>
                                            
                                            <t t-else="">
                                                <!-- Task par défaut -->
                                                <rect class="bpm_vertex"
                                                      width="120"
                                                      height="80"
                                                      rx="8"
                                                      fill="#007bff"
                                                      stroke="#0056b3"
                                                      stroke-width="2"/>
                                                <text x="60" y="40" 
                                                      text-anchor="middle" 
                                                      alignment-baseline="middle"
                                                      class="bpm_vertex_label"
                                                      fill="white" 
                                                      font-size="12" 
                                                      font-weight="bold">
                                                    <t t-esc="cell.label"/>
                                                </text>
                                            </t>
                                            
                                            <!-- Points de connexion (visibles au survol ou sélection) -->
                                            <t t-if="isHovered(cell) or isSelected(cell) or state.isConnecting">
                                                <t t-set="relPoints" t-value="getConnectionPointsRelative(cell)"/>
                                                
                                                <!-- Haut -->
                                                <circle t-att-cx="relPoints.top.x" 
                                                        t-att-cy="relPoints.top.y" 
                                                        r="6" 
                                                        fill="#28a745" 
                                                        stroke="#fff" 
                                                        stroke-width="2"
                                                        class="bpm_connection_point"
                                                        data-side="top"/>
                                                
                                                <!-- Droite -->
                                                <circle t-att-cx="relPoints.right.x" 
                                                        t-att-cy="relPoints.right.y" 
                                                        r="6" 
                                                        fill="#28a745" 
                                                        stroke="#fff" 
                                                        stroke-width="2"
                                                        class="bpm_connection_point"
                                                        data-side="right"/>
                                                
                                                <!-- Bas -->
                                                <circle t-att-cx="relPoints.bottom.x" 
                                                        t-att-cy="relPoints.bottom.y" 
                                                        r="6" 
                                                        fill="#28a745" 
                                                        stroke="#fff" 
                                                        stroke-width="2"
                                                        class="bpm_connection_point"
                                                        data-side="bottom"/>
                                                
                                                <!-- Gauche -->
                                                <circle t-att-cx="relPoints.left.x" 
                                                        t-att-cy="relPoints.left.y" 
                                                        r="6" 
                                                        fill="#28a745" 
                                                        stroke="#fff" 
                                                        stroke-width="2"
                                                        class="bpm_connection_point"
                                                        data-side="left"/>
                                            </t>
                                        </g>
                                    </t>
                                </t>
                            </g>
                        </g>
                    </svg>
                </div>
            </div>
            
            <!-- Panneau de propriétés pour les éléments sélectionnés -->
            <div class="bpm_properties_panel" t-if="state.selectedCells.length === 1">
                <t t-set="selectedCell" t-value="state.selectedCells[0]"/>
                <div class="bpm_properties_header">
                    <h5>
                        <i class="fa fa-cog me-2"/>
                        Propriétés
                    </h5>
                </div>
                <div class="bpm_properties_content">
                    <div class="form-group mb-3">
                        <label class="form-label">Label:</label>
                        <input type="text" 
                               class="form-control form-control-sm" 
                               t-model="selectedCell.label"
                               t-on-input="() => this.saveDefinition()"
                               placeholder="Nom de l'élément"/>
                    </div>
                    <t t-if="selectedCell.type === 'edge'">
                        <div class="form-group mb-3">
                            <label class="form-label">Personne assignée:</label>
                            <div class="alert alert-info">
                                <small>
                                    <i class="fa fa-info-circle"/>
                                    Pour assigner une personne, utilisez l'onglet "Transitions" dans le formulaire principal.
                                </small>
                            </div>
                        </div>
                    </t>
                </div>
            </div>
        </div>
    </t>
</templates>
