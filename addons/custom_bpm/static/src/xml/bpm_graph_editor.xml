<templates xml:space="preserve">
    <t t-name="custom_bpm.BpmGraphEditor">
        <div class="o_bpm_graph_editor">
            <!-- Barre d'outils -->
            <div class="o_bpm_toolbar">
                <button class="btn btn-secondary" t-on-click="() => this.addNode('start')" title="Ajouter un n≈ìud de d√©but">
                    ‚ûï D√©but
                </button>
                <button class="btn btn-secondary" t-on-click="() => this.addNode('task')" title="Ajouter une t√¢che">
                    ‚ûï T√¢che
                </button>
                <button class="btn btn-secondary" t-on-click="() => this.addNode('gateway')" title="Ajouter une d√©cision">
                    ‚ûï D√©cision
                </button>
                <button class="btn btn-secondary" t-on-click="() => this.addNode('end')" title="Ajouter un n≈ìud de fin">
                    ‚ûï Fin
                </button>
                <button 
                    class="btn btn-danger" 
                    t-on-click="deleteSelected"
                    t-att-disabled="!state.selectedNodeId and !state.selectedEdgeId"
                    title="Supprimer la s√©lection (Delete)">
                    üóëÔ∏è Supprimer
                </button>
                
                <div class="o_bpm_controls">
                    <button class="btn" t-on-click="zoomIn" title="Zoom avant (Ctrl + Molette)">üîç+</button>
                    <button class="btn" t-on-click="zoomOut" title="Zoom arri√®re (Ctrl + Molette)">üîç-</button>
                    <button class="btn" t-on-click="resetZoom" title="R√©initialiser le zoom">‚åÇ</button>
                    <span class="o_bpm_zoom_info" t-esc="Math.round(state.zoom * 100) + '%'"/>
                    <button 
                        class="btn" 
                        t-on-click="toggleSnapToGrid"
                        t-att-title="state.snapToGrid ? 'D√©sactiver l\'alignement sur la grille' : 'Activer l\'alignement sur la grille'"
                        t-att-class="'btn ' + (state.snapToGrid ? 'btn-primary' : 'btn-secondary')">
                        üìê Grille
                    </button>
                </div>
            </div>
            
            <!-- Zone de dessin -->
            <div 
                class="o_bpm_canvas_container" 
                t-att-class="getContainerClass()"
                t-ref="container"
                t-on-mousedown="onCanvasMouseDown"
                t-on-mousemove="onCanvasMouseMove"
                t-on-mouseup="onCanvasMouseUp"
                t-on-mouseleave="onCanvasMouseUp">
                
                <!-- Instructions -->
                <div class="o_bpm_instructions" t-if="state.showInstructions">
                    <h4>üí° Instructions</h4>
                    <ul>
                        <li><strong>Glisser</strong> : D√©placer un n≈ìud</li>
                        <li><strong>Shift + Clic</strong> : D√©marrer une connexion</li>
                        <li><strong>Clic sur point de connexion</strong> : D√©marrer/terminer connexion</li>
                        <li><strong>Clic sur autre n≈ìud</strong> : Terminer la connexion</li>
                        <li><strong>Clic sur canvas</strong> : Annuler la connexion</li>
                        <li><strong>Glisser le canvas</strong> : D√©placer la vue</li>
                        <li><strong>Ctrl + Molette</strong> : Zoom</li>
                        <li><strong>Delete</strong> : Supprimer la s√©lection</li>
                        <li><strong>Esc</strong> : Annuler la connexion</li>
                    </ul>
                    <button class="btn btn-sm btn-secondary" t-on-click="toggleInstructions" style="margin-top: 8px; width: 100%;">
                        Masquer
                    </button>
                </div>
                
                <!-- Raccourcis clavier -->
                <div class="o_bpm_shortcuts">
                    <strong>Raccourcis:</strong><br/>
                    <kbd>Delete</kbd> Supprimer<br/>
                    <kbd>Esc</kbd> Annuler connexion<br/>
                    <kbd>Ctrl</kbd> + <kbd>Molette</kbd> Zoom
                </div>
                
                <!-- SVG Canvas -->
                <svg 
                    class="o_bpm_canvas" 
                    t-ref="canvas"
                    width="100%"
                    height="100%"
                    style="min-height: 600px;">
                    
                    <defs>
                        <!-- Grille -->
                        <pattern id="bpm_grid" width="20" height="20" patternUnits="userSpaceOnUse">
                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#4a4a4a" stroke-width="0.5"/>
                        </pattern>
                        
                        <!-- Fl√®che pour les transitions -->
                        <marker 
                            id="arrow" 
                            markerWidth="10" 
                            markerHeight="10" 
                            refX="9" 
                            refY="3" 
                            orient="auto"
                            markerUnits="strokeWidth">
                            <path d="M0,0 L10,3 L0,6 Z" fill="#757575" class="o_bpm_edge_marker"/>
                        </marker>
                        
                        <!-- Gradient pour les n≈ìuds -->
                        <linearGradient id="nodeGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.2" />
                            <stop offset="100%" style="stop-color:#000000;stop-opacity:0.2" />
                        </linearGradient>
                    </defs>
                    
                    <!-- Grille de fond -->
                    <rect 
                        width="10000" 
                        height="10000" 
                        x="-5000" 
                        y="-5000" 
                        fill="url(#bpm_grid)" 
                        t-att-transform="'translate(' + state.panX + ',' + state.panY + ') scale(' + state.zoom + ')'"/>
                    
                    <!-- Groupe principal avec transformation zoom/pan -->
                    <g t-att-transform="'translate(' + state.panX + ',' + state.panY + ') scale(' + state.zoom + ')'">
                        
                        <!-- Transitions existantes et en attente -->
                        <g class="o_bpm_edges">
                            <t t-foreach="state.edges" t-as="edge" t-key="edge.id">
                                <path 
                                    t-att-d="edgePath(edge)"
                                    t-att-class="getEdgeClass(edge)"
                                    t-on-click="() => this.selectEdge(edge)"
                                    marker-end="url(#arrow)"/>
                            </t>
                            <t t-foreach="state.pendingEdges" t-as="edge" t-key="edge.id">
                                <path 
                                    t-att-d="edgePath(edge)"
                                    t-att-class="getEdgeClass(edge)"
                                    t-on-click="() => this.selectEdge(edge)"
                                    marker-end="url(#arrow)"
                                    stroke-dasharray="5,5"/>
                            </t>
                        </g>
                        
                        <!-- Connexion temporaire (pendant le drag) -->
                        <path 
                            t-if="state.connectingFrom and state.tempConnectionEnd"
                            t-att-d="tempConnectionPath()"
                            class="o_bpm_temp_connection"
                            marker-end="url(#arrow)"
                            stroke-width="3"/>
                        
                        <!-- N≈ìuds sauvegard√©s et en attente -->
                        <g class="o_bpm_nodes">
                            <t t-foreach="state.nodes" t-as="node" t-key="node.id">
                                <g 
                                    t-att-transform="nodeTransform(node)"
                                    t-on-mouseenter="() => this.state.hoveredNodeId = node.id"
                                    t-on-mouseleave="() => this.state.hoveredNodeId = null">
                                    
                                    <!-- N≈ìud de d√©but ou fin (cercle) -->
                                    <t t-if="node.node_type === 'start' or node.node_type === 'end'">
                                        <circle 
                                            r="25" 
                                            cx="25" 
                                            cy="25" 
                                            t-att-class="getNodeClass(node)"
                                            t-on-mousedown="(ev) => this.onNodeMouseDown(node, ev)"
                                            t-on-click="(ev) => this.selectNode(node, ev)"
                                            t-on-contextmenu.prevent="(ev) => this.startConnect(node, {cx: 25, cy: 25})"/>
                                        <text 
                                            x="25" 
                                            y="25" 
                                            text-anchor="middle" 
                                            dy=".3em" 
                                            font-size="11"
                                            font-weight="500">
                                            <t t-esc="node.name"/>
                                        </text>
                                        
                                        <!-- Points de connexion -->
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'top')"
                                            cx="25" 
                                            cy="0" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'top', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'right')"
                                            cx="50" 
                                            cy="25" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'right', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'bottom')"
                                            cx="25" 
                                            cy="50" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'bottom', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'left')"
                                            cx="0" 
                                            cy="25" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'left', ev)"/>
                                    </t>
                                    
                                    <!-- T√¢che (rectangle) -->
                                    <t t-if="node.node_type === 'task'">
                                        <rect 
                                            width="120" 
                                            height="80" 
                                            rx="6" 
                                            ry="6" 
                                            t-att-class="getNodeClass(node)"
                                            t-on-mousedown="(ev) => this.onNodeMouseDown(node, ev)"
                                            t-on-click="(ev) => this.selectNode(node, ev)"
                                            t-on-contextmenu.prevent="(ev) => this.startConnect(node, {cx: 60, cy: 40})"/>
                                        <text 
                                            x="60" 
                                            y="40" 
                                            text-anchor="middle" 
                                            dy=".3em" 
                                            font-size="12"
                                            font-weight="500">
                                            <t t-esc="node.name"/>
                                        </text>
                                        
                                        <!-- Points de connexion -->
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'top')"
                                            cx="60" 
                                            cy="0" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'top', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'right')"
                                            cx="120" 
                                            cy="40" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'right', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'bottom')"
                                            cx="60" 
                                            cy="80" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'bottom', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'left')"
                                            cx="0" 
                                            cy="40" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'left', ev)"/>
                                    </t>
                                    
                                    <!-- D√©cision (losange) -->
                                    <t t-if="node.node_type === 'gateway'">
                                        <polygon 
                                            points="30,0 60,30 30,60 0,30" 
                                            t-att-class="getNodeClass(node)"
                                            t-on-mousedown="(ev) => this.onNodeMouseDown(node, ev)"
                                            t-on-click="(ev) => this.selectNode(node, ev)"
                                            t-on-contextmenu.prevent="(ev) => this.startConnect(node, {cx: 30, cy: 30})"/>
                                        <text 
                                            x="30" 
                                            y="30" 
                                            text-anchor="middle" 
                                            dy=".3em" 
                                            font-size="11"
                                            font-weight="500">
                                            <t t-esc="node.name"/>
                                        </text>
                                        
                                        <!-- Points de connexion -->
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'top')"
                                            cx="30" 
                                            cy="0" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'top', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'right')"
                                            cx="60" 
                                            cy="30" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'right', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'bottom')"
                                            cx="30" 
                                            cy="60" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'bottom', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'left')"
                                            cx="0" 
                                            cy="30" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'left', ev)"/>
                                    </t>
                                </g>
                            </t>
                            <!-- N≈ìuds en attente (affich√©s avec un style diff√©rent) -->
                            <t t-foreach="state.pendingNodes" t-as="node" t-key="node.id">
                                <g 
                                    t-att-transform="nodeTransform(node)"
                                    t-on-mouseenter="() => this.state.hoveredNodeId = node.id"
                                    t-on-mouseleave="() => this.state.hoveredNodeId = null"
                                    opacity="0.8">
                                    
                                    <!-- N≈ìud de d√©but ou fin (cercle) -->
                                    <t t-if="node.node_type === 'start' or node.node_type === 'end'">
                                        <circle 
                                            r="25" 
                                            cx="25" 
                                            cy="25" 
                                            t-att-class="getNodeClass(node)"
                                            stroke-dasharray="3,3"
                                            t-on-mousedown="(ev) => this.onNodeMouseDown(node, ev)"
                                            t-on-click="(ev) => this.selectNode(node, ev)"
                                            t-on-contextmenu.prevent="(ev) => this.startConnect(node, {cx: 25, cy: 25})"/>
                                        <text 
                                            x="25" 
                                            y="25" 
                                            text-anchor="middle" 
                                            dy=".3em" 
                                            font-size="11"
                                            font-weight="500">
                                            <t t-esc="node.name"/>
                                        </text>
                                        
                                        <!-- Points de connexion -->
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'top')"
                                            cx="25" 
                                            cy="0" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'top', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'right')"
                                            cx="50" 
                                            cy="25" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'right', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'bottom')"
                                            cx="25" 
                                            cy="50" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'bottom', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'left')"
                                            cx="0" 
                                            cy="25" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'left', ev)"/>
                                    </t>
                                    
                                    <!-- T√¢che (rectangle) -->
                                    <t t-if="node.node_type === 'task'">
                                        <rect 
                                            width="120" 
                                            height="80" 
                                            rx="6" 
                                            ry="6" 
                                            t-att-class="getNodeClass(node)"
                                            stroke-dasharray="3,3"
                                            t-on-mousedown="(ev) => this.onNodeMouseDown(node, ev)"
                                            t-on-click="(ev) => this.selectNode(node, ev)"
                                            t-on-contextmenu.prevent="(ev) => this.startConnect(node, {cx: 60, cy: 40})"/>
                                        <text 
                                            x="60" 
                                            y="40" 
                                            text-anchor="middle" 
                                            dy=".3em" 
                                            font-size="12"
                                            font-weight="500">
                                            <t t-esc="node.name"/>
                                        </text>
                                        
                                        <!-- Points de connexion -->
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'top')"
                                            cx="60" 
                                            cy="0" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'top', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'right')"
                                            cx="120" 
                                            cy="40" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'right', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'bottom')"
                                            cx="60" 
                                            cy="80" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'bottom', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'left')"
                                            cx="0" 
                                            cy="40" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'left', ev)"/>
                                    </t>
                                    
                                    <!-- D√©cision (losange) -->
                                    <t t-if="node.node_type === 'gateway'">
                                        <polygon 
                                            points="30,0 60,30 30,60 0,30" 
                                            t-att-class="getNodeClass(node)"
                                            stroke-dasharray="3,3"
                                            t-on-mousedown="(ev) => this.onNodeMouseDown(node, ev)"
                                            t-on-click="(ev) => this.selectNode(node, ev)"
                                            t-on-contextmenu.prevent="(ev) => this.startConnect(node, {cx: 30, cy: 30})"/>
                                        <text 
                                            x="30" 
                                            y="30" 
                                            text-anchor="middle" 
                                            dy=".3em" 
                                            font-size="11"
                                            font-weight="500">
                                            <t t-esc="node.name"/>
                                        </text>
                                        
                                        <!-- Points de connexion -->
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'top')"
                                            cx="30" 
                                            cy="0" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'top', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'right')"
                                            cx="60" 
                                            cy="30" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'right', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'bottom')"
                                            cx="30" 
                                            cy="60" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'bottom', ev)"/>
                                        <circle 
                                            t-att-class="getConnectionPointClass(node, 'left')"
                                            cx="0" 
                                            cy="30" 
                                            t-on-click.stop="(ev) => this.onConnectionPointClick(node, 'left', ev)"/>
                                    </t>
                                </g>
                            </t>
                        </g>
                    </g>
                </svg>
            </div>
        </div>
    </t>
</templates>
