<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vue List pour bpm.process -->
    <record id="view_bpm_process_tree" model="ir.ui.view">
        <field name="name">bpm.process.tree</field>
        <field name="model">bpm.process</field>
        <field name="arch" type="xml">
            <list string="Processus BPM">
                <field name="name"/>
                <field name="model_id"/>
                <field name="version"/>
                <field name="active"/>
                <field name="instance_count"/>
            </list>
        </field>
    </record>

    <!-- Vue Form pour bpm.process avec éditeur graphique -->
    <record id="view_bpm_process_form" model="ir.ui.view">
        <field name="name">bpm.process.form</field>
        <field name="model">bpm.process</field>
        <field name="arch" type="xml">
            <form string="Processus BPM">
                <header>
                    <button name="action_view_instances" type="object" string="Voir les instances" 
                            class="oe_stat_button" icon="fa-tasks">
                        <field name="instance_count" widget="statinfo" string="Instances"/>
                    </button>
                </header>
                <!-- Chatter : Suivi des messages et activités
                     - message_follower_ids : Abonnés qui reçoivent les notifications
                     - activity_ids : Activités planifiées (tâches, appels, etc.)
                     - message_ids : Historique des messages et commentaires
                     Ces sections permettent de suivre les discussions et activités liées au processus BPM -->
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_validate_workflow" type="object" 
                                string="Valider le Workflow" 
                                class="oe_stat_button" 
                                icon="fa-check-circle"
                                help="Vérifie la cohérence du workflow"/>
                    </div>
                    
                    <widget name="web_ribbon" title="Invalide" bg_color="text-bg-danger" 
                            invisible="is_valid"/>
                    <widget name="web_ribbon" title="Valide" bg_color="text-bg-success" 
                            invisible="not is_valid"/>
                    
                    <group>
                        <group>
                            <field name="name"/>
                            <field name="model_id" options="{'no_create': True}"/>
                            <field name="model_name" readonly="1"/>
                            <field name="version"/>
                            <field name="active"/>
                        </group>
                        <group>
                            <field name="description" placeholder="Description du processus..."/>
                            <field name="is_valid" invisible="1"/>
                        </group>
                    </group>
                    
                    <group string="Déclenchement Automatique">
                        <group>
                            <field name="auto_start"/>
                            <field name="trigger_on" invisible="not auto_start"/>
                        </group>
                        <group>
                            <field name="trigger_condition" widget="text" 
                                   placeholder="record.state == 'draft' and record.amount_total > 1000"
                                   invisible="not auto_start"/>
                        </group>
                    </group>
                    
                    <group string="Validation du Workflow" invisible="is_valid">
                        <field name="validation_errors" widget="text" readonly="1" 
                               class="text-danger" nolabel="1"/>
                    </group>
                    
                    <!-- Notebook "données" (reste dans le sheet, largeur Odoo standard) -->
                    <notebook>
                        <page string="Éditeur Graphique" name="graph_editor">
                            <group>
                                <field name="json_definition" widget="bpm_graph_editor" nolabel="1"/>
                            </group>
                        </page>
                        <page string="Nœuds" name="nodes">
                            <field name="node_ids" nolabel="1">
                                <list editable="bottom">
                                    <field name="name"/>
                                    <field name="node_type"/>
                                    <field name="auto_action" optional="show"/>
                                    <field name="end_type" optional="hide"/>
                                    <field name="end_action" optional="hide"/>
                                    <field name="sequence" widget="handle"/>
                                    <field name="position_x"/>
                                    <field name="position_y"/>
                                    <field name="assigned_user_id"/>
                                    <field name="assigned_group_id"/>
                                </list>
                                <form>
                                    <sheet>
                                        <group>
                                            <group>
                                                <field name="name"/>
                                                <field name="node_type"/>
                                                <field name="process_id" invisible="1"/>
                                                <field name="node_id" readonly="1"/>
                                                <field name="sequence"/>
                                            </group>
                                            <group>
                                                <field name="position_x"/>
                                                <field name="position_y"/>
                                                <field name="assigned_user_id"/>
                                                <field name="assigned_group_id"/>
                                            </group>
                                        </group>
                                        <group string="Configuration de Fin" invisible="node_type != 'end'">
                                            <group>
                                                <field name="end_type"/>
                                                <field name="end_action"/>
                                            </group>
                                        </group>
                                        <group string="Action Automatique">
                                            <group>
                                                <field name="auto_action"/>
                                            </group>
                                        </group>
                                        <group string="Notifications Email">
                                            <group>
                                                <field name="send_email"/>
                                                <field name="email_to" invisible="not send_email"/>
                                                <field name="email_to_custom" invisible="email_to != 'custom' or not send_email"/>
                                            </group>
                                            <group>
                                                <field name="email_template_id" invisible="not send_email"/>
                                                <field name="email_subject" invisible="not send_email or email_template_id"/>
                                            </group>
                                        </group>
                                        <group string="Corps de l'email" invisible="not send_email or email_template_id">
                                            <field name="email_body" widget="html" nolabel="1"/>
                                        </group>
                                        <group>
                                            <field name="description" placeholder="Description du nœud..."/>
                                        </group>
                                        <group string="Code d'action">
                                            <field name="action_code" widget="text" 
                                                   placeholder="Code Python à exécuter lorsque ce nœud est atteint..."/>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                        </page>
                        <page string="Transitions" name="edges">
                            <field name="edge_ids" nolabel="1">
                                <list editable="bottom">
                                    <field name="name"/>
                                    <field name="source_node_id"/>
                                    <field name="target_node_id"/>
                                    <field name="assigned_user_id" optional="show"/>
                                    <field name="send_notification" optional="show"/>
                                    <field name="sequence" widget="handle"/>
                                </list>
                                <form>
                                    <sheet>
                                        <group>
                                            <group>
                                                <field name="name"/>
                                                <field name="process_id" invisible="1"/>
                                                <field name="edge_id" readonly="1"/>
                                                <field name="sequence"/>
                                            </group>
                                            <group>
                                                <field name="source_node_id" domain="[('process_id', '=', process_id)]"/>
                                                <field name="target_node_id" domain="[('process_id', '=', process_id)]"/>
                                            </group>
                                        </group>
                                        <group string="Condition de transition">
                                            <field name="condition_type" widget="radio"/>
                                            <field name="condition_field" 
                                                   invisible="condition_type != 'simple'"
                                                   placeholder="Ex: amount_total, state, partner_id.name"/>
                                            <field name="condition_operator" 
                                                   invisible="condition_type != 'simple'"/>
                                            <field name="condition_value" 
                                                   invisible="condition_type != 'simple'"
                                                   placeholder="Ex: 1000"/>
                                            <field name="condition" widget="text" 
                                                   invisible="condition_type != 'code'"
                                                   placeholder="Expression Python évaluée pour déterminer si cette transition peut être prise. Utilisez 'record' pour référencer l'enregistrement du modèle cible."/>
                                        </group>
                                        <group string="Assignation et Notification">
                                            <group>
                                                <field name="assigned_user_id" 
                                                       options="{'no_create': True}"
                                                       placeholder="Sélectionnez la personne qui doit exécuter l'action au nœud suivant"/>
                                                <field name="send_notification" 
                                                       help="Si activé, envoie automatiquement une notification/mail à la personne assignée quand cette connexion est utilisée"/>
                                            </group>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vue Kanban pour bpm.process -->
    <record id="view_bpm_process_kanban" model="ir.ui.view">
        <field name="name">bpm.process.kanban</field>
        <field name="model">bpm.process</field>
        <field name="arch" type="xml">
            <!-- Utilisation d'un kanban standard avec template 'kanban-box'
                 pour éviter l'erreur "Missing 'card' template" liée à o_kanban_dashboard -->
            <kanban string="Processus BPM">
                <field name="name"/>
                <field name="model_id"/>
                <field name="active"/>
                <field name="instance_count"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="model_id"/>
                                <div class="text-muted">
                                    <field name="instance_count"/> instance(s)
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vue List pour bpm.instance -->
    <record id="view_bpm_instance_tree" model="ir.ui.view">
        <field name="name">bpm.instance.tree</field>
        <field name="model">bpm.instance</field>
        <field name="arch" type="xml">
            <list string="Instances BPM">
                <field name="name"/>
                <field name="process_id"/>
                <field name="res_record"/>
                <field name="current_node_id"/>
                <field name="state" widget="badge" 
                       decoration-success="state == 'completed'"
                       decoration-info="state == 'running'"
                       decoration-warning="state == 'draft'"
                       decoration-danger="state == 'cancelled'"/>
                <field name="progress" widget="progressbar"/>
                <field name="start_date"/>
                <field name="end_date"/>
            </list>
        </field>
    </record>

    <!-- Vue Form pour bpm.instance -->
    <record id="view_bpm_instance_form" model="ir.ui.view">
        <field name="name">bpm.instance.form</field>
        <field name="model">bpm.instance</field>
        <field name="arch" type="xml">
            <form string="Instance BPM">
                <header>
                    <button name="action_start" type="object" string="Démarrer" 
                            class="btn-primary" invisible="state != 'draft'"/>
                    <button name="action_next_step" type="object" string="Étape suivante" 
                            class="btn-primary" invisible="state != 'running'"/>
                    <button name="action_cancel" type="object" string="Annuler" 
                            invisible="state in ['completed', 'cancelled']"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,running,completed"/>
                </header>
                <sheet>
                    <group>
                        <group>
                            <field name="name"/>
                            <field name="process_id" options="{'no_create': True}"/>
                            <field name="res_model"/>
                            <field name="res_id"/>
                            <field name="user_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="current_node_id" readonly="1"/>
                            <field name="progress" widget="progressbar"/>
                            <field name="start_date" readonly="1"/>
                            <field name="end_date" readonly="1"/>
                        </group>
                    </group>
                    
                    <!-- Barre de progression visuelle -->
                    <group string="Progression du processus" invisible="state == 'draft'">
                        <div class="o_stat_info">
                            <span class="o_stat_text">
                                <field name="progress" widget="progressbar" nolabel="1"/>
                            </span>
                        </div>
                        <div class="alert alert-info" role="alert" invisible="state != 'running'">
                            <strong>Étape actuelle :</strong> <field name="current_node_id" readonly="1" nolabel="1"/>
                        </div>
                    </group>
                    
                    <!-- Historique des nœuds visités -->
                    <group string="Historique" invisible="state == 'draft'">
                        <field name="history_node_ids" nolabel="1" readonly="1">
                            <list>
                                <field name="name"/>
                                <field name="node_type"/>
                            </list>
                        </field>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Action pour bpm.process -->
    <record id="action_bpm_process" model="ir.actions.act_window">
        <field name="name">Processus BPM</field>
        <field name="res_model">bpm.process</field>
        <field name="view_mode">list,form,kanban</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Créez votre premier processus BPM !
            </p>
            <p>
                Définissez des processus métiers dynamiques avec un éditeur graphique.
            </p>
        </field>
    </record>

    <!-- Action pour bpm.instance -->
    <record id="action_bpm_instance" model="ir.actions.act_window">
        <field name="name">Instances BPM</field>
        <field name="res_model">bpm.instance</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Aucune instance de processus
            </p>
            <p>
                Les instances sont créées automatiquement lorsque vous lancez un processus.
            </p>
        </field>
    </record>

</odoo>

